<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpendWise | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-50 min-h-screen pb-12">
    <nav class="bg-white border-b px-6 py-4 flex justify-between items-center mb-8">
        <h1 class="text-xl font-bold text-indigo-600 flex items-center">
            <i class="fa-solid fa-receipt mr-2"></i>SpendWise
        </h1>
        <div class="flex items-center gap-3">
            <a href="/export" class="flex items-center gap-2 px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wider bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition shadow-sm">
                <i class="fa-solid fa-file-export text-sm"></i> Export CSV
            </a>
            <% if (userEmail === ADMIN_EMAIL) { %>
                <a href="/toggle-role" class="flex items-center gap-2 px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wider transition-all shadow-sm <%= role === 'admin' ? 'bg-amber-500 text-white hover:bg-amber-600' : 'bg-slate-800 text-white hover:bg-slate-900' %>">
                    <i class="fa-solid <%= role === 'admin' ? 'fa-toggle-on' : 'fa-toggle-off' %> text-sm"></i>
                    <%= role === 'admin' ? 'Admin Mode' : 'User Mode' %>
                </a>
            <% } %>
            <a href="/logout" class="bg-slate-100 hover:bg-red-100 text-slate-500 hover:text-red-600 p-2 rounded-lg transition"><i class="fa-solid fa-power-off"></i></a>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto px-6">
        <div class="bg-indigo-600 rounded-3xl p-8 text-white shadow-xl shadow-indigo-100 flex justify-between items-center mb-8">
            <div>
                <p class="text-indigo-100 text-xs uppercase font-bold tracking-widest"><%= role === 'admin' ? 'System-Wide Total' : 'My Total Spending' %></p>
                <h2 class="text-5xl font-black mt-2 leading-none">
                    $<%= parseFloat(totalSpent).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                </h2>
            </div>
            <div class="hidden md:block bg-indigo-500 p-5 rounded-2xl"><i class="fa-solid fa-wallet text-3xl text-white/80"></i></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-2xl border shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4 tracking-tight">Add Transaction</h3>
                    <form action="/add" method="POST" class="space-y-4">
                        <input type="number" name="amount" step="0.01" required placeholder="0.00" class="w-full border p-3 rounded-xl bg-slate-50">
                        <select name="category" class="w-full border p-3 rounded-xl bg-slate-50">
                            <option>Food</option><option>Transport</option><option>Housing</option><option>Shopping</option><option>Other</option>
                        </select>
                        <input type="text" name="description" placeholder="Description" class="w-full border p-3 rounded-xl bg-slate-50">
                        <input type="date" name="date" required class="w-full border p-3 rounded-xl bg-slate-50">
                        <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition active:scale-95">Save</button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-2xl border shadow-sm">
                    <h3 class="font-bold text-slate-800 mb-4 tracking-tight">Spending Insights</h3>
                    <div class="space-y-5">
                        <% 
                            const numericTotal = parseFloat(totalSpent); 
                            Object.keys(categoryTotals).forEach(cat => { 
                                const rawPerc = numericTotal > 0 ? ((categoryTotals[cat] / numericTotal) * 100).toFixed(0) : 0;
                                const labelString = rawPerc + " %";
                                const widthString = rawPerc + "%";
                        %>
                        <div>
                            <div class="flex justify-between text-[10px] mb-1.5 font-bold text-slate-400 uppercase tracking-widest">
                                <span><%= cat %></span><span><%= labelString %></span>
                            </div>
                            <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                <div class="bg-indigo-500 h-full transition-all duration-1000 ease-out category-bar" data-width="<%= widthString %>"></div>
                            </div>
                        </div>
                        <% }); %>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl border shadow-sm overflow-hidden min-h-[500px]">
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                        <span class="font-bold text-slate-600 text-sm"><%= role === 'admin' ? 'Master Audit Log' : 'My Transactions' %></span>
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded <%= role === 'admin' ? 'bg-indigo-100 text-indigo-700' : 'bg-slate-100 text-slate-600' %> uppercase">Viewing as <%= role %></span>
                    </div>
                    <div class="divide-y divide-slate-100">
                        <% expenses.forEach(ex => { %>
                            <div class="p-4 flex justify-between items-center hover:bg-slate-50/80 transition">
                                <div>
                                    <p class="font-bold text-slate-800"><%= ex.description || 'General' %></p>
                                    <p class="text-[11px] text-slate-400 font-medium">
                                        <span class="text-indigo-400 font-bold"><%= ex.category %></span> • <%= ex.date %> 
                                        <% if(role === 'admin') { %> • <span class="text-slate-600 font-bold"><%= ex.email %></span> <% } %>
                                    </p>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="font-black text-slate-900 leading-none">
                                        $<%= ex.amount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                                    </span>
                                    <form action="/delete/<%= ex.id %>" method="POST" onsubmit="return confirm('Permanently delete?')">
                                        <button class="text-slate-300 hover:text-red-500 p-2"><i class="fa-solid fa-trash-can text-sm"></i></button>
                                    </form>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.category-bar').forEach(bar => {
                const width = bar.getAttribute('data-width');
                setTimeout(() => { bar.style.width = width; }, 100);
            });
        });
    </script>
</body>
</html>